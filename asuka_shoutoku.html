<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>é£›é³¥æ™‚ä»£ï¼šè–å¾³å¤ªå­ã®å›½ã¥ãã‚Š</title>
  <style>
    body{
      font-family:"Meiryo", sans-serif;
      max-width:960px;
      margin:20px auto;
      line-height:1.8;
      background:#f4f4f9;
      font-size:16px;
      padding-bottom:170px; /* å›ºå®šèªç¾¤ã®é«˜ã•ç¢ºä¿ */
    }
    h1{ margin-bottom:8px; }
    h2{ margin-top:18px; margin-bottom:8px; font-size:20px; }

    /* åˆ°é”ãƒãƒ¼ */
    .step-bar{
      display:flex; gap:8px; margin:16px 0 20px 0; justify-content:space-between;
    }
    .step{
      flex:1; text-align:center; padding:6px 4px; border-radius:999px;
      background:#ddd; font-size:13px; cursor:pointer; position:relative; user-select:none;
    }
    .step::before{
      content: attr(data-step);
      display:inline-block; width:18px; height:18px; line-height:18px;
      border-radius:50%; background:#aaa; color:#fff; font-size:12px; margin-right:4px;
    }
    .step.active{ background:#e0f0ff; }
    .step.done{ background:#b3e5fc; }
    .step.done::before{ background:#0288d1; }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚«ãƒ¼ãƒ‰ */
    .section{
      display:none;
      background:#fff;
      border-radius:8px;
      padding:14px 16px;
      border:1px solid #ccc;
      margin-bottom:16px;
    }
    .section.active{ display:block; }

    /* ç©ºæ¬„ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .blank{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 120px;
      min-height: 34px;
      padding: 2px 12px;
      box-sizing: border-box;
      border-radius: 8px;
      border: 1px solid #9ad3a2;
      background: #e9f8ec;
      margin: 0 4px;
      text-align: center;
      vertical-align: middle;
      cursor: pointer;
      user-select: none;
      font-weight: bold;
    }
    .blank.correct {
      border-color: #4caf50;
      background: #c8e6c9;
    }

    /* ãµã‚ŠãŒãª */
    .reading{ color:#444; margin-left:2px; }
    .challenge-mode .reading{ display:none; }

    /* popãƒ©ã‚¤ãƒ³ */
    .pop-line{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid #ffb0b0;
      background:#ffecec;
      margin:10px 0 14px 0;
    }
    .pop-title{ font-weight:bold; color:#b30000; font-size:14px; }
    .pop-btn{
      padding:7px 12px;
      border-radius:10px;
      border:none;
      background:#ff6b6b;
      color:#fff;
      cursor:pointer;
      font-size:13px;
      white-space:nowrap;
    }
    .pop-btn:hover{ filter:brightness(0.98); }

    /* ãƒœã‚¿ãƒ³åˆ— */
    .controls{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    button{
      padding:8px 14px;
      border-radius:8px;
      border:none;
      background:#1976d2;
      color:#fff;
      cursor:pointer;
      font-size:15px;
    }
    button.secondary{ background:#666; }
    button:disabled{ opacity:0.5; cursor:default; }

    .result-message{ margin-top:6px; font-weight:bold; font-size:14px; }

    .timer-info{
      margin-top:8px;
      padding:6px 10px;
      font-size:15px;
      color:#222;
      border-radius:6px;
      border:1px solid #1976d2;
      background:#fff;
      display:inline-block;
    }

    .explain-box{
      margin-top:10px;
      padding:8px;
      border-left:4px solid #1976d2;
      background:#f0f4ff;
      display:none;
      font-size:14px;
    }

    /* å›ºå®šèªç¾¤ */
    .wordbank-fixed{
      position:fixed;
      left:0; right:0; bottom:0;
      background:#f4f4f9;
      border-top:1px solid #ccc;
      padding:10px 0;
      z-index:9990;
      display:none;
    }
    .wordbank-inner{
      max-width:960px;
      margin:0 auto;
      padding:0 10px;
    }
    .word-bank-title{ font-weight:bold; margin-bottom:6px; font-size:14px; }
    .word-bank{
      border:1px solid #ccc;
      border-radius:8px;
      padding:10px;
      min-height:52px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      background:#fafafa;
    }
    .word-chip{
      padding:8px 12px;
      border-radius:18px;
      border:1px solid #666;
      background:#f5f5f5;
      cursor:pointer;
      user-select:none;
      font-size:14px;
    }
    .word-chip.used{ opacity:0.3; cursor:default; }
    .word-chip.selected-chip{
      border-color:#1976d2;
      background:#e3f2fd;
      box-shadow:0 0 0 2px #bbdefb;
    }

    /* å›³ã®è¡¨ç¤º */
    .img-row{ display:flex; gap:12px; flex-wrap:wrap; align-items:flex-start; margin:12px 0; }
    .img-card{ background:#fff; border:1px solid #ddd; border-radius:10px; padding:10px; width:min(440px, 100%); }
    .img-card img{ width:100%; height:auto; border-radius:8px; border:1px solid #eee; display:block; }
    .img-caption{ margin-top:8px; font-weight:bold; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

    /* æ¬¡ã®å˜å…ƒ */
    .next-unit-fixed{
      position:fixed; right:18px; bottom:190px;
      z-index:9991; background:#2e7d32; color:#fff;
      text-decoration:none; padding:10px 14px; border-radius:12px;
      font-weight:bold; box-shadow:0 6px 14px rgba(0,0,0,0.15);
    }

    /* ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
    .popup-overlay{
      position:fixed; inset:0;
      background:rgba(0,0,0,0.4);
      display:none; align-items:center; justify-content:center;
      z-index:9999;
    }
    .popup-box{
      background:#fff; max-width:600px; width:92%; padding:20px;
      border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,0.3);
      font-size:15px; line-height:1.7;
    }
    .popup-title{ font-weight:bold; margin-bottom:10px; font-size:17px; color:#b30000; border-bottom:1px solid #eee; padding-bottom:5px; }
    .popup-close-btn{
      margin-top:15px; padding:8px 20px; border-radius:8px;
      border:none; background:#1976d2; color:#fff; cursor:pointer;
    }
  </style>
</head>

<body>
  <h1>ğŸŒ¸ é£›é³¥æ™‚ä»£ï¼šè–å¾³å¤ªå­ã®å›½ã¥ãã‚Š</h1>

  <a class="next-unit-fixed" href="#" title="æ¬¡ã®å˜å…ƒã¸">æ¬¡ã®å˜å…ƒã«è¡Œã</a>

  <div class="step-bar">
    <div class="step active" data-step="1">â‘  ä»æ•™ã¨å¤ªå­</div>
    <div class="step" data-step="2">â‘¡ åˆ¶åº¦ã¨æ†²æ³•</div>
    <div class="step" data-step="3">â‘¢ é£éš‹ä½¿</div>
    <div class="step" data-step="4">â‘£ é£›é³¥æ–‡åŒ–</div>
  </div>

  <div class="section active" data-section="1">
    <h2>1. ä»æ•™ã‚’ã‚ãã‚‹äº‰ã„ã¨è–å¾³å¤ªå­ã®ç™»å ´</h2>
    <div class="pop-line">
      <div class="pop-title">pop1ï¼šãªãœç™¾æ¸ˆã¯ä»æ•™ã‚’æ—¥æœ¬ã«ä¼ãˆãŸã®ã‹</div>
      <button class="pop-btn" onclick="showPopup('pop1')">è§£èª¬ã‚’è¦‹ã‚‹</button>
    </div>
    <div class="pop-line">
      <div class="pop-title">pop2ï¼šãªãœè˜‡æˆ‘æ°ã¯ä»æ•™ã‚’ãˆã‚‰ã‚“ã ã®ã‹</div>
      <button class="pop-btn" onclick="showPopup('pop2')">è§£èª¬ã‚’è¦‹ã‚‹</button>
    </div>

    <div class="question-text">
      6ä¸–ç´€å¾ŒåŠã€æ—¥æœ¬ã«ä¼ã‚ã£ãŸ[ <span class="blank" data-section="1" data-blank-id="A"></span> ]<span class="reading">ï¼ˆã¶ã£ãã‚‡ã†ï¼‰</span>ã‚’å—ã‘å…¥ã‚Œã‚‹ã‹ã©ã†ã‹ã§ã€æœ‰åŠ›ãªè±ªæ—åŒå£«ã®æ¿€ã—ã„äº‰ã„ãŒèµ·ã“ã‚Šã¾ã—ãŸã€‚<br><br>
      [ <span class="blank" data-section="1" data-blank-id="B"></span> ]<span class="reading">ï¼ˆããŒã†ã˜ï¼‰</span>ï¼šå¤©çš‡ä¸­å¿ƒã®æ”¿æ²»ã®ãŸã‚ã«ä»æ•™ãŒå¿…è¦ã ã¨è€ƒãˆã¾ã—ãŸã€‚<br><br>
      [ <span class="blank" data-section="1" data-blank-id="C"></span> ]<span class="reading">ï¼ˆã‚‚ã®ã®ã¹ã†ã˜ï¼‰</span>ï¼šæ—¥æœ¬å¤æ¥ã®ç¥æ§˜ã‚’å¤§åˆ‡ã«ã™ã‚‹ç«‹å ´ã‹ã‚‰åå¯¾ã—ã¾ã—ãŸã€‚<br><br>
      çµæœã€è˜‡æˆ‘æ°ãŒç‰©éƒ¨æ°ã‚’å€’ã—ã€ä¸€æ—ã®[ <span class="blank" data-section="1" data-blank-id="D"></span> ]<span class="reading">ï¼ˆã™ã„ã“ã¦ã‚“ã®ã†ï¼‰</span>ã‚’ç«‹ã¦ã¾ã—ãŸã€‚ã“ã®æ™‚ã€å¤©çš‡ã«ä»£ã‚ã£ã¦æ”¿æ²»ã‚’è¡Œã†[ <span class="blank" data-section="1" data-blank-id="E"></span> ]<span class="reading">ï¼ˆã›ã£ã—ã‚‡ã†ï¼‰</span>ã«ä»»å‘½ã•ã‚ŒãŸã®ãŒã€ç”¥ã®[ <span class="blank" data-section="1" data-blank-id="F"></span> ]<span class="reading">ï¼ˆã—ã‚‡ã†ã¨ããŸã„ã—ï¼‰</span>ã§ã™ã€‚
    </div>

    <div class="controls">
      <button class="start-btn" data-section="1">ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–‹å§‹</button>
      <button class="check-btn" data-section="1">åˆ¤å®š</button>
      <button class="secondary reset-btn" data-section="1">ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="next-section-btn" data-section="1" disabled>æ¬¡ã¸ â–¶</button>
      <button class="secondary explain-btn" data-section="1">ã€è§£èª¬ã€‘</button>
    </div>
    <div class="result-message" id="result-1"></div>
    <div class="timer-info" id="timer-1">çµŒéæ™‚é–“ï¼š---</div>
    <div class="explain-box" id="explain-1">
      è˜‡æˆ‘æ°ã¨ç‰©éƒ¨æ°ãŒå¯¾ç«‹ã—ã€å‹åˆ©ã—ãŸè˜‡æˆ‘æ°ãŒæ¨å¤å¤©çš‡ã‚’å³ä½ã•ã›ã¾ã—ãŸã€‚è–å¾³å¤ªå­ã¯æ‘‚æ”¿ã¨ã—ã¦æ”¿æ²»ã‚’åŠ©ã‘ã¾ã—ãŸã€‚
    </div>
  </div>

  <div class="section" data-section="2">
    <h2>2. è–å¾³å¤ªå­ã®æ–°ã—ã„å›½ã¥ãã‚Šï¼ˆåˆ¶åº¦ã¨æ†²æ³•ï¼‰</h2>
    <div class="pop-line">
      <div class="pop-title">pop3ï¼šãªãœè˜‡æˆ‘æ°ã‚’æ”¿ç•Œã‹ã‚‰é ã–ã‘ã‚ˆã†ã¨ã—ãŸã®ã‹</div>
      <button class="pop-btn" onclick="showPopup('pop3')">è§£èª¬ã‚’è¦‹ã‚‹</button>
    </div>
    <div class="question-text">
      [ <span class="blank" data-section="2" data-blank-id="A"></span> ]<span class="reading">ï¼ˆã‹ã‚“ã„ã˜ã‚…ã†ã«ã‹ã„ï¼‰</span>ï¼š603å¹´åˆ¶å®šã€‚å®¶æŸ„ã«é–¢ä¿‚ãªãèƒ½åŠ›ã®ã‚ã‚‹äººã‚’å½¹äººã«é¸ã¶åˆ¶åº¦ã§ã™ã€‚<br><br>
      [ <span class="blank" data-section="2" data-blank-id="B"></span> ]<span class="reading">ï¼ˆã˜ã‚…ã†ã—ã¡ã˜ã‚‡ã†ã®ã‘ã‚“ã½ã†ï¼‰</span>ï¼š604å¹´åˆ¶å®šã€‚å½¹äººã®å¿ƒãŒã¾ãˆã‚’èª¬ã„ãŸæ³•å¾‹ã§ã™ã€‚
    </div>
    <div class="controls">
      <button class="start-btn" data-section="2">ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–‹å§‹</button>
      <button class="check-btn" data-section="2">åˆ¤å®š</button>
      <button class="next-section-btn" data-section="2" disabled>æ¬¡ã¸ â–¶</button>
    </div>
    <div class="result-message" id="result-2"></div>
    <div class="timer-info" id="timer-2"></div>
  </div>

  <div class="section" data-section="3">
    <h2>3. å¤–å›½ã¨ã®å¤–äº¤ï¼ˆé£éš‹ä½¿ï¼‰</h2>
    <div class="pop-line">
      <div class="pop-title">pop4ï¼šä¸­å›½ï¼ˆéš‹ï¼‰ã¨å¯¾ç­‰å¤–äº¤ã‚’è¡ŒãˆãŸç†ç”±</div>
      <button class="pop-btn" onclick="showPopup('pop4')">è§£èª¬ã‚’è¦‹ã‚‹</button>
    </div>
    <div class="question-text">
      è–å¾³å¤ªå­ã¯ã€607å¹´ã«[ <span class="blank" data-section="3" data-blank-id="A"></span> ]<span class="reading">ï¼ˆã‘ã‚“ãšã„ã—ï¼‰</span>ã®[ <span class="blank" data-section="3" data-blank-id="B"></span> ]<span class="reading">ï¼ˆãŠã®ã®ã„ã‚‚ã“ï¼‰</span>ã‚‰ã‚’ä¸­å›½ï¼ˆ[ <span class="blank" data-section="3" data-blank-id="C"></span> ]ï¼‰ã¸é€ã‚Šã¾ã—ãŸã€‚å½“æ™‚ã®éš‹ã¯[ <span class="blank" data-section="3" data-blank-id="D"></span> ]ã¨ã®å¯¾ç«‹ã‚‚ã‚ã‚Šã€æ—¥æœ¬ã¨ã®äº¤æµã‚’å—ã‘å…¥ã‚Œã¾ã—ãŸã€‚
    </div>
    <div class="controls">
      <button class="start-btn" data-section="3">ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–‹å§‹</button>
      <button class="check-btn" data-section="3">åˆ¤å®š</button>
      <button class="next-section-btn" data-section="3" disabled>æ¬¡ã¸ â–¶</button>
    </div>
    <div class="result-message" id="result-3"></div>
    <div class="timer-info" id="timer-3"></div>
  </div>

  <div class="section" data-section="4">
    <h2>4. é£›é³¥æ–‡åŒ–ï¼ˆæ—¥æœ¬åˆã®ä»æ•™æ–‡åŒ–ï¼‰</h2>
    <div class="question-text">
      è–å¾³å¤ªå­ãŒæ´»èºã—ãŸæ™‚ä»£ã®æ–‡åŒ–ã‚’[ <span class="blank" data-section="4" data-blank-id="A"></span> ]ã¨ã„ã„ã¾ã™ã€‚
      <div class="img-row">
        <div class="img-card">
          <img src="{{ url_for('static', filename='img/history/houryuji.png') }}" alt="æ³•éš†å¯º">
          <div class="img-caption">å›³ï¼š[ <span class="blank" data-section="4" data-blank-id="B"></span> ]</div>
        </div>
        <div class="img-card">
          <img src="{{ url_for('static', filename='img/history/shakasansonzou.png') }}" alt="é‡ˆè¿¦ä¸‰å°Šåƒ">
          <div class="img-caption">å›³ï¼š[ <span class="blank" data-section="4" data-blank-id="C"></span> ]</div>
          <div style="font-size:13px; margin-top:5px;">ä½œè€…ï¼š[ <span class="blank" data-section="4" data-blank-id="D"></span> ]</div>
        </div>
      </div>
    </div>
    <div class="controls">
      <button class="start-btn" data-section="4">ãƒãƒ£ãƒ¬ãƒ³ã‚¸é–‹å§‹</button>
      <button class="check-btn" data-section="4">åˆ¤å®š</button>
      <button class="next-section-btn" data-section="4" disabled>å…¨ã‚¯ãƒªã‚¢ï¼</button>
    </div>
    <div class="result-message" id="result-4"></div>
    <div class="timer-info" id="timer-4"></div>
  </div>

  <div id="popup-overlay" class="popup-overlay" onclick="hidePopup()">
    <div class="popup-box" onclick="event.stopPropagation()">
      <div id="popup-title" class="popup-title"></div>
      <div id="popup-body" class="popup-body"></div>
      <button class="popup-close-btn" onclick="hidePopup()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="wordbank-fixed" class="wordbank-fixed">
    <div class="wordbank-inner">
      <div class="word-bank-title">ã€èªç¾¤ã€‘ï¼ˆã‚¯ãƒªãƒƒã‚¯ã—ã¦ç©ºæ¬„ã‚’åŸ‹ã‚ã‚ˆã†ï¼‰</div>
      <div class="word-bank" id="word-bank"></div>
    </div>
  </div>

<script>
  const sectionData = {
    1: { answers: { A:"ä»æ•™", B:"è˜‡æˆ‘æ°", C:"ç‰©éƒ¨æ°", D:"æ¨å¤å¤©çš‡", E:"æ‘‚æ”¿", F:"è–å¾³å¤ªå­" }, choices: ["ä»æ•™","è˜‡æˆ‘æ°","ç‰©éƒ¨æ°","æ¨å¤å¤©çš‡","æ‘‚æ”¿","è–å¾³å¤ªå­"] },
    2: { answers: { A:"å† ä½åäºŒéš", B:"åä¸ƒæ¡ã®æ†²æ³•" }, choices: ["å† ä½åäºŒéš","åä¸ƒæ¡ã®æ†²æ³•"] },
    3: { answers: { A:"é£éš‹ä½¿", B:"å°é‡å¦¹å­", C:"éš‹", D:"é«˜å¥éº—" }, choices: ["é£éš‹ä½¿","å°é‡å¦¹å­","éš‹","é«˜å¥éº—"] },
    4: { answers: { A:"é£›é³¥æ–‡åŒ–", B:"æ³•éš†å¯º", C:"é‡ˆè¿¦ä¸‰å°Šåƒ", D:"éä½œé³¥" }, choices: ["é£›é³¥æ–‡åŒ–","æ³•éš†å¯º","é‡ˆè¿¦ä¸‰å°Šåƒ","éä½œé³¥"] }
  };

  const POPUP_DATA = {
    pop1: { title: "ãªãœç™¾æ¸ˆã¯ä»æ•™ã‚’æ—¥æœ¬ã«ä¼ãˆãŸã®ã‹", body: "ç™¾æ¸ˆã¯éš£å›½ã®åœ§è¿«ã‹ã‚‰é€ƒã‚Œã‚‹ãŸã‚ã€æ—¥æœ¬ã«è»äº‹æ”¯æ´ã‚’æ±‚ã‚ã¦ã„ã¾ã—ãŸã€‚ãã®ã€Œå¤–äº¤ã®åˆ‡ã‚Šæœ­ã€ã¨ã—ã¦ã€å½“æ™‚æœ€æ–°ã®é«˜åº¦ãªçŸ¥è­˜ä½“ç³»ã§ã‚ã£ãŸä»æ•™ã‚’ä¼ãˆãŸã®ã§ã™ã€‚" },
    pop2: { title: "ãªãœè˜‡æˆ‘æ°ã¯ä»æ•™ã‚’ãˆã‚‰ã‚“ã ã®ã‹", body: "è˜‡æˆ‘æ°ã¯æ¸¡æ¥äººã¨ç¹‹ãŒã‚ŠãŒæ·±ãã€ä»æ•™ã¨ã„ã†æ–°ã—ã„æ•™ãˆã‚’å–ã‚Šå…¥ã‚Œã‚‹ã“ã¨ã§ã€å¤ã„ç¿’æ…£ã«ç¸›ã‚‰ã‚ŒãŸä»–ã®è±ªæ—ã‚’åœ§å€’ã—ã€å¤©çš‡ã‚’ä¸­å¿ƒã¨ã—ãŸæ–°ã—ã„å›½ã¥ãã‚Šã‚’ä¸»å°ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚" },
    pop3: { title: "ãªãœè˜‡æˆ‘æ°ã‚’æ”¿ç•Œã‹ã‚‰é ã–ã‘ã‚ˆã†ã¨ã—ãŸã®ã‹", body: "æ¨å¤å¤©çš‡ã¨è–å¾³å¤ªå­ã¯ã€ç‰¹å®šã®è±ªæ—ï¼ˆè˜‡æˆ‘æ°ï¼‰ãŒæ¨©åŠ›ã‚’ç‹¬å ã™ã‚‹ã®ã‚’é˜²ããŸã‹ã£ãŸãŸã‚ã€å€‹äººã®èƒ½åŠ›ã‚’é‡è¦–ã™ã‚‹ã€Œå† ä½åäºŒéšã€ãªã©ã‚’å°å…¥ã—ã€å¤©çš‡ä¸­å¿ƒã®æ”¿æ²»ã‚’ç›®æŒ‡ã—ã¾ã—ãŸã€‚" },
    pop4: { title: "ä¸­å›½ï¼ˆéš‹ï¼‰ã¨å¯¾ç­‰å¤–äº¤ã‚’è¡ŒãˆãŸç†ç”±", body: "å½“æ™‚ã€éš‹ã¯é«˜å¥éº—ã¨ã®æˆ¦äº‰ã«å‚™ãˆã¦ãŠã‚Šã€æ—¥æœ¬ãŒæ•µå¯¾ã™ã‚‹ã“ã¨ã‚’æã‚Œã¦ã„ã¾ã—ãŸã€‚è–å¾³å¤ªå­ã¯ãã®å›½éš›æƒ…å‹¢ã‚’èª­ã¿ã€å¼·æ°—ã®ã€Œå¯¾ç­‰å¤–äº¤ã€ã‚’ä»•æ›ã‘ãŸã®ã§ã™ã€‚" }
  };

  let currentSection = 1;
  let selectedChip = null;
  const sectionStates = { 1:{ attempts:[], startTime:null, intervalId:null }, 2:{ attempts:[], startTime:null, intervalId:null }, 3:{ attempts:[], startTime:null, intervalId:null }, 4:{ attempts:[], startTime:null, intervalId:null } };

  // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—åˆ¶å¾¡
  function showPopup(key) {
    const data = POPUP_DATA[key];
    document.getElementById('popup-title').textContent = data.title;
    document.getElementById('popup-body').textContent = data.body;
    document.getElementById('popup-overlay').style.display = 'flex';
  }
  function hidePopup() { document.getElementById('popup-overlay').style.display = 'none'; }

  // èªç¾¤ã®ã‚·ãƒ£ãƒƒãƒ•ãƒ«
  function shuffle(arr) { return arr.slice().sort(() => Math.random() - 0.5); }

  // èªç¾¤ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
  function renderWordBank(section) {
    document.getElementById('wordbank-fixed').style.display = 'block';
    const bank = document.getElementById('word-bank');
    bank.innerHTML = '';
    shuffle(sectionData[section].choices).forEach(word => {
      const chip = document.createElement('div');
      chip.className = 'word-chip';
      chip.textContent = word;
      chip.onclick = () => {
        if (chip.classList.contains('used')) return;
        if (selectedChip) selectedChip.classList.remove('selected-chip');
        selectedChip = chip;
        chip.classList.add('selected-chip');
      };
      bank.appendChild(chip);
    });
  }

  // ã‚¿ã‚¤ãƒãƒ¼
  function startTimer(section) {
    const state = sectionStates[section];
    state.startTime = Date.now();
    state.intervalId = setInterval(() => {
      const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
      document.getElementById(`timer-${section}`).textContent = `çµŒéæ™‚é–“ï¼š${elapsed}ç§’`;
    }, 1000);
  }

  // ç©ºæ¬„ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†
  document.querySelectorAll('.blank').forEach(blank => {
    blank.onclick = () => {
      if (Number(blank.dataset.section) !== currentSection) return;
      if (selectedChip) {
        if (blank.dataset.word) {
          const oldChip = Array.from(document.querySelectorAll('.word-chip')).find(c => c.textContent === blank.dataset.word);
          if (oldChip) oldChip.classList.remove('used');
        }
        blank.textContent = selectedChip.textContent;
        blank.dataset.word = selectedChip.textContent;
        selectedChip.classList.add('used');
        selectedChip.classList.remove('selected-chip');
        selectedChip = null;
      } else if (blank.dataset.word) {
        const oldChip = Array.from(document.querySelectorAll('.word-chip')).find(c => c.textContent === blank.dataset.word);
        if (oldChip) oldChip.classList.remove('used');
        blank.textContent = '';
        blank.dataset.word = '';
      }
    };
  });

  // åˆ¤å®šå‡¦ç†
  function checkSection(section) {
    const blanks = document.querySelectorAll(`.blank[data-section="${section}"]`);
    let allCorrect = true;
    blanks.forEach(b => {
      if (b.dataset.word === sectionData[section].answers[b.dataset.blankId]) {
        b.classList.add('correct');
      } else {
        allCorrect = false;
        b.classList.remove('correct');
      }
    });

    const res = document.getElementById(`result-${section}`);
    if (allCorrect) {
      clearInterval(sectionStates[section].intervalId);
      res.textContent = "â­• æ­£è§£ï¼ãŠè¦‹äº‹ã§ã™ã€‚";
      res.style.color = "green";
      document.querySelector(`.next-section-btn[data-section="${section}"]`).disabled = false;
      document.querySelector(`.step[data-step="${section}"]`).classList.add('done');
    } else {
      res.textContent = "âŒ é•ã†ç®‡æ‰€ãŒã‚ã‚Šã¾ã™ã€‚ã‚‚ã†ä¸€åº¦è¦‹ç›´ãã†ã€‚";
      res.style.color = "red";
    }
  }

  // å„ç¨®ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
  document.querySelectorAll('.start-btn').forEach(btn => {
    btn.onclick = () => {
      const s = Number(btn.dataset.section);
      currentSection = s;
      document.body.classList.add('challenge-mode');
      document.querySelectorAll(`.blank[data-section="${s}"]`).forEach(b => { b.textContent = ''; b.dataset.word = ''; b.classList.remove('correct'); });
      renderWordBank(s);
      startTimer(s);
    };
  });

  document.querySelectorAll('.check-btn').forEach(btn => {
    btn.onclick = () => checkSection(Number(btn.dataset.section));
  });

  document.querySelectorAll('.next-section-btn').forEach(btn => {
    btn.onclick = () => {
      const next = Number(btn.dataset.section) + 1;
      if (next <= 4) goToSection(next);
    };
  });

  function goToSection(s) {
    currentSection = s;
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.querySelector(`.section[data-section="${s}"]`).classList.add('active');
    document.querySelectorAll('.step').forEach(st => st.classList.remove('active'));
    document.querySelector(`.step[data-step="${s}"]`).classList.add('active');
    document.getElementById('wordbank-fixed').style.display = 'none';
    document.body.classList.remove('challenge-mode');
  }

  // åˆæœŸåŒ–ï¼šæœ€åˆã¯ç­”ãˆã‚’å…¥ã‚ŒãŸçŠ¶æ…‹ã§è¡¨ç¤º
  window.onload = () => {
    for (let s = 1; s <= 4; s++) {
      const blanks = document.querySelectorAll(`.blank[data-section="${s}"]`);
      blanks.forEach(b => {
        b.textContent = sectionData[s].answers[b.dataset.blankId];
        b.dataset.word = b.textContent;
      });
    }
  };

  function toggleExplain(s) {
    const box = document.getElementById(`explain-${s}`);
    box.style.display = (box.style.display === 'block') ? 'none' : 'block';
  }
  document.querySelectorAll('.explain-btn').forEach(btn => {
    btn.onclick = () => toggleExplain(Number(btn.dataset.section));
  });
</script>
</body>
</html>